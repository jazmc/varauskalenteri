<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<!-- CSS only -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU"
	crossorigin="anonymous">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Anonymous+Pro&family=Patrick+Hand+SC&display=swap" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="css/css.css" th:href="@{css/css.css}" />
<link type="text/css" rel="stylesheet" href="css/timepicker.css" th:href="@{css/timepicker.css}" />
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
<script src="https://kit.fontawesome.com/7e7cff31ed.js"
	crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
<script src="timepicker.js" th:src="@{timepicker.js}"></script>

<head>
<title>Varauskalenteri</title>
  
</head>
<body>
	<div class="verho">
		<div class="verhonsisalto">
			<div id="varausid" style="display:none"></div>
			<div id="suljenappi"><i class="fas fa-times-circle"></i></div>
			<table>
				<tr>
					<th id="varausotsikko" colspan="4"></th>
				</tr>
				<tr>
					<td class="ots">Alkaa</td>
					<td id="varausalku"></td>
					<td class="ots">Päättyy</td>
					<td id="varausloppu"></td>
				</tr>
				<tr>
					<td class="ots">Lisätiedot</td>
					<td colspan="3" id="selite"></td>
				</tr>
				<tr>
					<th colspan="4">Varaajan tiedot</th>
				</tr>
				<tr>
					<td class="ots">Nimi</td>
					<td id="varaajaetu"></td>
					<td class="ots">Yhteystiedot</td>
					<td id="varaajapuhelin"></td>
				</tr>
			</table>
			<div id="poistoloota"></div>
		</div>
	</div>
	<div class="varausverho">
		<div class="verhonsisalto">
			<div id="vikapv" style="display:none" th:text="${vikapv}"></div>
			<div id="suljevaraus"><i class="fas fa-times-circle"></i></div>
			<h3>Uusi varaus</h3>
			
			<form id="varausform" th:action="@{/add}" method="post">
				<input id="salku" type="hidden" name="salku" value=""/>
				<input id="sloppu" type="hidden" name="sloppu" value=""/>
				<table>
					<tr>
						<th colspan="2">Varaus alkaa</th>
						<th colspan="2">Varaus päättyy</th>
					</tr>
					<tr>
						<td>Pvm.</td>
						<td id="alkupv"><input type="text" id="alkudate" class="datepicker" size="30"></td>
						<td class="ots">Pvm.</td>
						<td id="loppupv"><input type="text" id="loppudate" class="datepicker" size="30"></td>
					</tr>
					<tr>
						<td>Klo.</td>
						<td id="alkuh"><input type="text" style="width: 100%" id="alkupicker" class="timepickerit" value="13:30"></td>
						<td class="ots">Klo.</td>
						<td id="loppuh"><input type="text" style="width: 100%" id="loppupicker" class="timepickerit" value="13:30"></td>
					</tr>
					<tr>
						<td>Kuvaus</td>
						<td colspan="3">
							<textarea style="width:100%; height:4em;" id="varauksenkuvaus" name="selitys" placeholder="esim. Reitti, lennon tyyppi, ..."></textarea>
						</td>
					</tr>
				</table>
				<input type="hidden" name="u" th:value="${#httpServletRequest.remoteUser}"/>
				<input type="hidden" name="cat" th:value="1"/>
				<div class="conttinen"></div>
				<div class="valitusloota"><i>Varauksen minimikesto on yksi (1) tunti.<br>
				Järjestelmä ei huomioi varausten päällekkäisyyksiä. Tarkistathan varausta tehdessäsi, että kone on vapaana koko varauksesi ajalle.</i></div>
				<br>
				<button type="button" class="btn btn-outline-success" id="vahvistavaraus">Vahvista varaus</button>
				<button type="button" class="btn btn-outline-danger" id="peruutavaraus">Peruuta</button>
			</form>
			
		</div>
	</div>
	<div class="ylaosa">
	<h1 th:inline="text">LENTOVARAUSKALENTERI</h1>
	<div class="flex">
	<p class="kayttajainfo">Tervetuloa, <b id="kayttis" th:attr="data-kayttaja=${#httpServletRequest.remoteUser}"></b>!<br>
	Varauskalenteri päivitetty <span th:text="${#dates.format(#dates.createNow(),'dd.MM.yyyy HH:mm')}">Päivämäärä</span></p>
	<form  style="display:inline-block;" th:action="@{/logout}" method="post">
		<input type="submit" class="btn btn-outline-light" value="Kirjaudu ulos" />
	</form>
	</div>
	<br>
	<br>
	

	</div>

	<div class="kalenteripohja">
		<table class="varauspohja">
			<tr class="stay">
				<th>
					<div class="ylanamikat">
						<div class="vasenselektori">
							<a class="btn btn-outline-light btn-sm" th:href="${#temporals.format(kkeka, 'MM')} eq 1 ? @{'?kk=12&v=' + ${#numbers.formatInteger(#temporals.year(kkeka)-1, 1)}} : @{'?kk=' + ${#numbers.formatInteger(#temporals.month(kkeka)-1, 1)} + '&v=' + ${#temporals.format(kkeka, 'yyyy')}}"><i class="fas fa-arrow-circle-left"></i> Edellinen kuukausi</a>
						</div>
						<th:block th:switch="${#temporals.format(kkeka, 'MM')}">
							<span th:case="1">Tammikuu [[${#temporals.format(kkeka, 'yyyy')}]]</span>
							<span th:case="2">Helmikuu [[${#temporals.format(kkeka, 'yyyy')}]]</span>
							<span th:case="3">Maaliskuu [[${#temporals.format(kkeka, 'yyyy')}]]</span>
							<span th:case="4">Huhtikuu [[${#temporals.format(kkeka, 'yyyy')}]]</span>
							<span th:case="5">Toukokuu [[${#temporals.format(kkeka, 'yyyy')}]]</span>
							<span th:case="6">Kesäkuu [[${#temporals.format(kkeka, 'yyyy')}]]</span>
							<span th:case="7">Heinäkuu [[${#temporals.format(kkeka, 'yyyy')}]]</span>
							<span th:case="8">Elokuu [[${#temporals.format(kkeka, 'yyyy')}]]</span>
							<span th:case="9">Syyskuu [[${#temporals.format(kkeka, 'yyyy')}]]</span>
							<span th:case="10">Lokakuu [[${#temporals.format(kkeka, 'yyyy')}]]</span>
							<span th:case="11">Marraskuu [[${#temporals.format(kkeka, 'yyyy')}]]</span>
							<span th:case="12">Joulukuu [[${#temporals.format(kkeka, 'yyyy')}]]</span>
						</th:block>
						<div class="oikeaselektori">
							<a class="btn btn-outline-light btn-sm" th:href="${#temporals.format(kkeka, 'MM')} eq 12 ? @{'?kk=1&v=' + ${#numbers.formatInteger(#temporals.year(kkeka)+1, 1)}} : @{'?kk=' + ${#numbers.formatInteger(#temporals.month(kkeka)+1, 1)} + '&v=' + ${#temporals.format(kkeka, 'yyyy')}}">Seuraava kuukausi <i class="fas fa-arrow-circle-right"></i></a>
						</div>
					</div>
				</th>
				<td class="flex">
					<div th:each="i : ${#numbers.sequence(0, 23, 1)}"
						th:text="${#numbers.formatInteger(i,2)}"></div>
				</td>
			</tr>
			<tr th:each="i : ${#numbers.sequence(1, vikapv, 1)}"
				th:class="${#temporals.dayOfWeek(kkeka.plusDays(i-1))==7} ? 'sunnuntai'"
				th:id="${#dates.format(#dates.createNow(),'yyyy') eq #temporals.format(kkeka, 'yyyy') and #dates.format(#dates.createNow(),'MM') eq #temporals.format(kkeka, 'MM') and #dates.format(#dates.createNow(),'dd') eq #numbers.formatInteger(i,2)} ? 'tanaan'">
				<td class="stay"
					th:switch="${#temporals.dayOfWeek(kkeka.plusDays(i-1))}"><span
					th:case="1">Maanantai</span><span th:case="2">Tiistai</span><span
					th:case="3">Keskiviikko</span><span th:case="4">Torstai</span><span
					th:case="5">Perjantai</span><span th:case="6">Lauantai</span><span
					th:case="7">Sunnuntai</span>
					<div class="pvanro"
						th:text="@{${#numbers.formatInteger(i,2)} + '.' + ${#temporals.format(kkeka, 'MM')} + '.'}"></div>
				</td>
				<td th:class="${i%2==0} ? 'flex parillinen' : 'flex pariton'"><div class="tunti" th:each="j : ${#numbers.sequence(0, 23, 1)}"
						th:id="@{${#temporals.year(kkeka)} + '/' + ${#temporals.month(kkeka)} + '/' + ${#numbers.formatInteger(i,2)} + '/' + ${#numbers.formatInteger(j,2)}}"><th:block th:each="varaus: ${varaukset}"><div th:attr="rel=${varaus.id}, data-varaaja=${varaus.user.id}, data-loppu=${#temporals.format(varaus.loppu, 'dd.MM.yyyy HH:mm')}" th:class="${#strings.toLowerCase(varaus.kategoria.name)}"
								th:if="${#temporals.format(kkeka, 'yyyy') == #temporals.format(varaus.alku, 'yyyy') and #temporals.format(kkeka, 'MM') == #temporals.format(varaus.alku, 'MM') and #numbers.formatInteger(j,2) eq #temporals.format(varaus.alku, 'HH') and #numbers.formatInteger(i,2) eq #temporals.format(varaus.alku, 'dd')}"
								th:text="@{${varaus.kategoria.name == 'Huolto'} ? 'HUOLTO ' : ${varaus.user.etunimi} + ' ' + ${#strings.substring(varaus.user.sukunimi, 0,1)} + '.'}"
								th:style="${#temporals.format(varaus.alku, 'mm') eq '30'} ? 'margin-left:50%;width:calc('+${varaus.kesto}+' * (100% + 1px));' : 'width:calc('+${varaus.kesto}+' * (100% + 1px));'"></div><div th:attr="rel=${varaus.id}, data-varaaja=${varaus.user.id}, data-loppu=${#temporals.format(varaus.loppu, 'dd.MM.yyyy HH:mm')}" th:class="${#strings.toLowerCase(varaus.kategoria.name)}"
								th:if="${#temporals.format(kkeka, 'yyyy') == #temporals.format(varaus.alku, 'yyyy') and #temporals.format(kkeka, 'MM') == #temporals.format(varaus.alku, 'MM') and #temporals.day(varaus.alku) < i and #temporals.day(varaus.loppu) > i and j == 0}"
								th:text="@{${varaus.kategoria.name == 'Huolto'} ? 'HUOLTO (jatkuu) ' : ${varaus.user.etunimi} + ' ' + ${#strings.substring(varaus.user.sukunimi, 0,1)} + '. (jatkuu)'}"
								th:style="'width:calc('+${varaus.kesto}+' * (100% + 1px)); border-top-left-radius:0; border-bottom-left-radius:0;'"></div><div th:attr="rel=${varaus.id}, data-varaaja=${varaus.user.id}, data-loppu=${#temporals.format(varaus.loppu, 'dd.MM.yyyy HH:mm')}" th:class="${#strings.toLowerCase(varaus.kategoria.name)}"
								th:if="${#temporals.format(kkeka, 'yyyy') == #temporals.format(varaus.alku, 'yyyy') and #temporals.format(kkeka, 'MM') == #temporals.format(varaus.alku, 'MM') and #temporals.day(varaus.alku) < i and #temporals.day(varaus.loppu) == i and #numbers.formatInteger(j,2) eq #temporals.format(varaus.loppu, 'HH')}"
								th:text="@{${varaus.kategoria.name == 'Huolto'} ? 'HUOLTO (päättyy)' : ${varaus.user.etunimi} + ' ' + ${#strings.substring(varaus.user.sukunimi, 0,1)} + '. (päättyy)'}"
								th:style="${#temporals.format(varaus.loppu, 'mm') eq '30'} ? 'margin-right:-50%;width:calc('+${varaus.kesto}+' * (100% + 1px)); left:unset; right:100%; text-align:right;' : 'width:calc('+${varaus.kesto}+' * (100% + 1px)); left:unset; right:100%; text-align:right;'"></div></th:block></div></td>
			</tr>
		</table>
	</div>
	<footer>webdesign &copy; Jasmin Lumme</footer>

	<script>
		var kayttis = $("#kayttis").attr("data-kayttaja");
		haeKayttaja(kayttis);
		var hetki = new Date();
		var nytten = [hetki.getFullYear(), hetki.getMonth()+1, hetki.getDate(), hetki.getHours()];
		var nyt = [];
		var koskettu = false;
		var suoritaladatessa = function() {
			for(var k of nytten) {
				if (k < 10) {
					k = "0" + k;
				}
				nyt.push(k);
			}
			nyt = nyt.join("");
			
			$(".tunti").each(function() {
				var elemid = $(this).attr("id");
				var tunninid = elemid.split("/").join("");
				if(tunninid < nyt) {
					$(this).addClass("wanha");
				}
			});
		}
		
		suoritaladatessa();
		
		$('.huolto').css('background-color', '#baa29d');
		
		$('.lentovaraus').each(function(){
			var varijono = ['#DAB5FF', '#ffb593', '#b3f0c8', '#ff93d5', '#93daff', '#ff9393', '#a293ff', '#fffb93'];
			var varaajanid = $(this).attr("data-varaaja");
			$(this).css('background-color', varijono[varaajanid-1]);
		});
		
		$('.lentovaraus, .huolto').mouseover(function() {
			var varauksenid = $(this).attr("rel");
			$('div[rel='+varauksenid+']').css('opacity', '1');
		});
		
		$('.lentovaraus, .huolto').mouseout(function() {
			var varauksenid = $(this).attr("rel");
			if ($(this).parent().is(".wanha")) {
				$('div[rel='+varauksenid+']').css('opacity', '.6');
			} else {
				$('div[rel='+varauksenid+']').css('opacity', '.9');
			}

		});

		$('.lentovaraus, .huolto').click(function() {
			var varauksenid = $(this).attr("rel");
			haeVaraus(varauksenid);
		});
		
		$(".verho, #suljenappi i").click(function(e) {
			if(e.target !== this) {
				return;
			}
			tyhjennaVerho();
		});
		
		$(".varausverho, #suljevaraus i, #peruutavaraus").click(function(e) {
			if(e.target !== this) {
				return;
			}
			tyhjennaVarausverho();
		});
		
		// varausnapin klikki
		$(document).on('click', '#varausnappi', function(e){
			koskettu = true;
			$(".varausverho").fadeIn();
			var vikapv = $("#vikapv").text();
			
			var alkuv = $(this).parent().attr("id").split("/")[0];
			var alkukk = $(this).parent().attr("id").split("/")[1];
			var alkupv = $(this).parent().attr("id").split("/")[2];
			var alkuh = $(this).parent().attr("id").split("/")[3];
			
			$( "#alkudate" ).datepicker( "setDate", alkupv + "." + alkukk + "." + alkuv );
			$( "#loppudate" ).datepicker( "setDate", alkupv + "." + alkukk + "." + alkuv );
			
			var aika = alkupv + "." + alkukk + "." + alkuv + " " + alkuh + ":30";
			if ($( "div[data-loppu='" + aika + "']").length > 0) {
				$( "#alkupicker" ).val( alkuh + ":30" );
				$( "#loppupicker" ).val( (parseInt(alkuh) + 1) + ":30" );
			} else {
				$( "#alkupicker" ).val( alkuh + ":00" );
				$( "#loppupicker" ).val( (parseInt(alkuh) + 1) + ":00" );
			}

		});
		
		$(".tunti").not(':parent').click(function(e) {
			if(e.target !== this) {
				return;
			}
			var elemid = $(this).attr("id");
			var tunninid = elemid.split("/").join("");
			if(tunninid < nyt) {
				return;
			}
			var muodostaaika = elemid.split("/");
			var dataloppu = muodostaaika[2] + "." + muodostaaika[1] + "." + muodostaaika[0] + " " + muodostaaika[3] + ":30";
			$("#varausnappi").remove();
			if ($( "div[data-loppu='" + dataloppu + "']").length > 0) {
				$(this).append("<button id=\"varausnappi\" class=\"btn btn-sm btn-success\" style=\"margin-left:50%;\">VARAA</button>");
			} else {
				$(this).append("<button id=\"varausnappi\" class=\"btn btn-sm btn-success\">VARAA</button>");
			}
			
		});

		$('.muokkaa').not('.spessu').click(
				function() {
					var asia = $(this).attr('rel');
					var id = $(this).attr('name');
					var value = $('#' + asia + id).attr('contenteditable');

					if (value == "false") {
						$("#" + asia + id).attr('contenteditable', 'true');
						$("span").not("#" + asia + id).attr('contenteditable',
								'false');
						$(this).html('<i class="far fa-save"></i>');
						$('.muokkaa').not(this).html(
								'<i class="far fa-edit"></i>');
					} else {
						var arvo = $("#" + asia + id).text();
						window.location.href = '/edit/' + id + '/' + asia + '/'
								+ arvo;
					}
				});
		$('.spessu').click(
				function() {

					var asia = $(this).attr('rel');
					var id = $(this).attr('name');
					var value = $(this).html();

					if (value.indexOf("edit") > 0) {
						$("#catlist" + id).css("display", "inline-block");
						$("#category" + id).hide();
						$(this).html('<i class="far fa-save"></i>');
					} else {
						var arvo = $("#catlist" + id).val();
						if (arvo != "" && arvo != null) {
							window.location.href = '/edit/' + id + '/' + asia
									+ '/' + arvo;
						}
					}

				});
		function haeVaraus(id) {
			$.ajax({
			    url: "/varaukset/"+id,
			    type: "GET",
			    dataType: "json",
			    data: {},
			    success: function(data){
			        naytaVaraus(data);
			    },
			    error: function(error){
			         alert("Error, errorin kuvaus consolessa");
			         console.log(error);
			    }
			});
		}
		
		function haeKayttaja(uname) {
			$.ajax({
			    url: "/kayttajat/"+uname,
			    type: "GET",
			    dataType: "json",
			    data: {},
			    success: function(data){
			        $("#kayttis").html(data.etunimi + " " + data.sukunimi);
			    },
			    error: function(error){
			         alert("Käyttäjätietojen hakeminen ei onnistunut. Ota yhteys järjestelmän ylläpitäjään.");
			         console.log(error);
			    }
			});
		}
		
		function naytaVaraus(data) {
			var loppuolio = new Date(data.loppu);
			var onkovanha = hetki > loppuolio;
			if ((kayttis == data.user.username || kayttis == "admin") && !onkovanha) {
				$("#poistoloota").append("<div><button class=\"btn btn-outline-primary\"/>Muokkaa varausta</button> <button class=\"btn btn-outline-danger\" onclick=\"vahvistaPoisto()\"/>Poista varaus</button></div>")
			}
			$("#varausid").html(data.id);
			$("#varausotsikko").append("<span>"+ data.kategoria.name +"</span>");
			$("#varaajaetu").append("<span>" + data.user.etunimi + " " + data.user.sukunimi + "</span>")
			$("#varaajapuhelin").append("<span>p. " + data.user.phone + ", " + data.user.email + "</span>")
			$("#selite").append("<span>" + data.selitys + "</span>")
			var valku = formatoiPaivays(data.alku);
			var vloppu = formatoiPaivays(data.loppu);
			$("#varausalku").append("<span>" + valku + "</span>");
			$("#varausloppu").append("<span>" + vloppu + "</span>");
			$(".verho").fadeIn();
		}
		
		function tyhjennaVerho() {
			$(".verho").hide();
			$("#varausid, #varaajaetu, #varausotsikko, #varaajapuhelin, #varausalku, #varausloppu, #selite, #poistoloota").html("");
		}
		
		function tyhjennaVarausverho() {
			$(".varausverho").hide();
		}
		
		function formatoiPaivays(input) {
			  function pad(s) { return (s < 10) ? '0' + s : s; }
			  var d = new Date(input)
			  var paivaysosa = [pad(d.getDate()), pad(d.getMonth()+1), d.getFullYear()].join('.')
			  var tuntiosa = [pad(d.getHours()), pad(d.getMinutes())].join(':')
			  return paivaysosa + " klo " + tuntiosa
		}
		
		function vahvistaPoisto() {
			var poistettavaid = $("#varausid").html();
			if (confirm('Haluatko varmasti poistaa tämän varauksen?')) {
			    location.href = '/delete/'+poistettavaid;
			} else {
			    return;
			}
		}
		

		function vahtaaKestoa(val) {
			if (koskettu == true) {
				console.log(val);
				var alkupaiva = $( "#alkudate" ).datepicker( "getDate" );
				var loppupaiva = $( "#loppudate" ).datepicker( "getDate" );
				var alkutunnit = $( "#alkupicker" ).val();
				var lopputunnit = $( "#loppupicker" ).val();
				let [ahour, aminute] = alkutunnit.split(':');
				let [lhour, lminute] = lopputunnit.split(':');
				alkupaiva.setHours(ahour);
				alkupaiva.setMinutes(aminute);
				loppupaiva.setHours(lhour);
				loppupaiva.setMinutes(lminute);
				
				if(loppupaiva < alkupaiva) {
					alert("Varauksen loppu ei voi olla ennen sen alkua!\nMuokkaa äsken antamaasi arvoa.");
					$("#vahvistavaraus").prop("disabled", true);
					return false;
				} else if ((loppupaiva-alkupaiva)/1000/60 < 60) {
					alert("Varauksen minimikesto on 1 tunti! Muokkaa äsken antamaasi arvoa.");
					$("#vahvistavaraus").prop("disabled", true);
					return false;
				} else {
					$("#vahvistavaraus").prop("disabled", false);
					return true;
				}
			}
			
		}
		  $( function kutsuPickeria() {
			    $( ".datepicker" ).datepicker({ minDate: -0, maxDate: "+2Y", onSelect: function(e) { if (vahtaaKestoa(e) == false && e != null) { $(this).datepicker("setDate", null) }} });
			    $( ".datepicker" ).datepicker( "option", "showAnim", "fadeIn" );
			    $( ".datepicker" ).datepicker( "option", "firstDay", 1 );
			    $( ".datepicker" ).datepicker( "option", "dateFormat", "dd.mm.yy" );
			  } );
			  
		$('.timepickerit').timepicker({
		    timeFormat: 'HH:mm',
		    interval: 30,
		    minTime: '12:00am',
		    maxTime: '11:59pm',
		    startTime: '00:00',
		    dynamic: false,
		    dropdown: true,
		    scrollbar: true,
		    change: function(e) { if (vahtaaKestoa(e) == false && e != null) { $(this).val(null) }}
		});
		
		$("#vahvistavaraus").click(function(){
			var alkudeitti = new Date();
			var alkuarvo = $("#alkudate").datepicker( "getDate" );
			var alkutiima = $("#alkupicker").timepicker( "getTime" );
			var loppudeitti = new Date();
			var loppuarvo = $("#loppudate").datepicker( "getDate" );
			var lopputiima = $("#loppupicker").timepicker("getTime");
			
			alkudeitti.setFullYear(alkuarvo.getFullYear(), alkuarvo.getMonth(), alkuarvo.getDate());
			alkudeitti.setHours(alkutiima.getHours(), alkutiima.getMinutes(), 0, 0);
			loppudeitti.setFullYear(loppuarvo.getFullYear(), loppuarvo.getMonth(), loppuarvo.getDate());
			loppudeitti.setHours(lopputiima.getHours(), lopputiima.getMinutes(), 0, 0);
			$("#salku").val(alkudeitti.toISOString());
			$("#sloppu").val(loppudeitti.toISOString());
			$("#varausform").submit();
		});
	</script>
</body>
</html>